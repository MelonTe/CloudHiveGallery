# 一、后端框架说明

设计如下：

```cmd
├───cmd                          # 项目启动入口（`main.go`）
├───config                       # 配置文件目录
├───internal                     # 业务核心代码，不对外暴露
│   ├───controller               # 控制器层，处理请求和响应
│   ├───middleware               # 中间件，如认证、日志、CORS 等
│   ├───model                    # 数据模型（数据库表结构等）
│   ├───repository               # 数据访问层，数据库操作封装
|   ├───ecode					 # 错误code的定义
|   ├───common					 # 统一结构定义，例如统一响应
│   └───service                  # 业务逻辑层，处理实际业务
├───pkg                          # 通用模块，其他包的工具
│   ├───cache                    # 缓存模块（如 Redis）
│   └───db                       # 数据库连接和初始化
├───router                       # 路由层，配置路由
│   └───v1                       # v1 版本的 API 路由
└───tests                        # 测试代码（单元测试、集成测试）

```

# 二、后端技术选型

- 缓存库`Ristretto`

# 三、问题集合

### 1、`swag`的`docs.go`多出了两个字段

```go
go get -u github.com/swaggo/swag
```

### 2、`swagger`启动后，访问`doc.js`失败

在main函数中，引入docs包即可

```
_ "shg/docs"
```

### 3、出现了资源跨域请求错误

当前端向后端发送请求，出现以下错误：

```cmd
Access to XMLHttpRequest at 'http://localhost:8080/v1/hello' from origin 'http://localhost:5173' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.
```

这是后端的CROS设置：

```go
//启用 CORS 中间件，允许跨域资源共享
	r.Use(cors.New(cors.Config{
		AllowOrigins:     []string{"*"},                             // 允许的来源（前端地址）
		AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},           // 允许的 HTTP 方法
		AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"}, // 允许的请求头
		ExposeHeaders:    []string{"Content-Length", "Authorization"},                   // 允许暴露的响应头
		AllowCredentials: true,                                                          // 是否允许携带凭证（如 Cookies）
		AllowWildcard:    true,                                                          // 是否允许任何来源
	}))
```

错误出现在，当要求`AllowWildcard`为true时，`AllowOrigins`不能为*，必须指定具体的路径。

### 4、后端的错误处理不够完善，在Service层和controller层重复

开始时，在controller层遇到错误是返回错误的形式，这个错误的go自带的错误，根据发生的业务错误找到具体的错误码和错误信息，生成error返回。但是在service层，根据这个错误又要再返回具体的错误code，重复了。

改进error，封装了错误信息和错误code，使得controller能返回这个封装好的错误，在service层从这个错误提取错误信息和code，避免重复冗余。

```go
// 错误返回结构体，避免信息重复
type ErrorWithCode struct {
	Code int
	Msg  string
}
// GetErrWithDetail 返回带状态码的错误
func GetErrWithDetail(code int, msg string) *ErrorWithCode {
	errMsg, ok := errMsgMap[code]
	if !ok {
		errMsg = "未知错误"
	}
	return &ErrorWithCode{
		Code: code,
		Msg:  fmt.Sprintf("%s: %s", errMsg, msg),
	}
}
```

